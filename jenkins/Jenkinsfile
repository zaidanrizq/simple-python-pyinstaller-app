node {
    stage('Checkout') {
        checkout scm
    }

    stage('Build') {
        docker.image('python:2-alpine').inside {
            sh 'python -m py_compile sources/add2vals.py sources/calc.py'
        }
    }

    stage('Test') {
        docker.image('qnib/pytest').inside {
            try {
                sh 'py.test --verbose --junit-xml test-reports/results.xml sources/test_calc.py'
            } finally {
                junit 'test-reports/results.xml'
            }
        }
    }

    stage('Manual Approval') {
        input message: 'Lanjutkan ke tahap Deploy? (Proceed untuk melanjutkan eksekusi pipeline ke tahap Deploy)'
    }

    stage('Deploy') {
        docker.image('python:2-alpine').inside("--entrypoint=''") {
            try {
                sh '''
		    echo "Installing PyInstaller..."
		    pip install --no-cache-dir pyinstaller

                    echo "Running PyInstaller..."
                    pyinstaller --onefile sources/add2vals.py

                    echo "Checking for dist directory..."
                    ls -la dist/
                '''
            } catch (Exception e) {
                echo "Error: PyInstaller failed or dist directory not found!"
		throw e
            } finally {
                archiveArtifacts artifacts: 'dist/add2vals', allowEmptyArchive: false
            }
        }

        // Run the app containerized via Docker on the EC2 instance
        sshagent(['Add2Val-Instance-Key']) {
            sh '''
                ssh -o StrictHostKeyChecking=no ec2-user@52.77.247.20 << EOF
                    docker run --rm --name add2vals-app -d -v $(pwd)/dist:/app -w /app python:2-alpine python add2vals.py
                    echo "Container is running on EC2 instance at 52.77.247.20"
                EOF
            '''
        }

        sleep time: 1, unit: 'MINUTES'
    }
}
